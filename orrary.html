<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Ontology-driven Orrery</title>
		<style>
      body { margin: 0; overflow: hidden;}
      canvas { width: 100%; height: 100%; vertical-align:bottom}
        .panel {
            width: 300px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: absolute;
            top: 50%;
            left: 10%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .panel h1 {
            margin: 0;
            font-size: 28px;
            color: #fff;
        }
        .panel .subtitle {
            font-size: 14px;
            text-transform: uppercase;
            color: #9e9e9e;
            margin-top: 8px;
        }
        .panel p {
            margin-top: 12px;
            font-size: 14px;
            color: #bdbdbd;
            line-height: 1.6;
        }
        .special-options {
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        .special-options a {
            display: block;
            color: #00b0ff;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .special-options a:hover {
            text-decoration: underline;
        }
		</style>
	</head>
	<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.40/jquery.csv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.3.15/jsonld.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/25.0.0/tween.umd.js"></script>
    <script src="TrackballControls.js"></script>
    <script src="OrbitalPropagator.js"></script>

        <script id="OrbitOntology" type="application/ld+json">
          {
            "@context": {
              "CelestialEntity": "http://www.w3.org/2002/07/owl#NamedIndividual",
              "Name": "http://www.w3.org/2001/XMLSchema#Name",
              "name": "http://www.semanticweb.org/rrovetto/ontologies/2014/space-situational-awareness-ontology#has_name",
              "double": "http://www.w3.org/2001/XMLSchema#double",
              "decimal": "http://www.w3.org/2001/XMLSchema#decimal",
              "graph": "@graph",
              "type": "@type",
              "value": "@value"
            },
            "graph": [
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Mercury_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Mercury_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.20563"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "3.38"
                },
                "raan": {
                  "type": "decimal",
                  "value": "48.331"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "0.387098"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "88.0"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "281.01"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "29.124"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Venus_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Venus_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.006772"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "3.86"
                },
                "raan": {
                  "type": "decimal",
                  "value": "76.68"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "0.723332"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "224.701"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "272.76"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "54.884"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Earth_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Earth_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.016708"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "7.155"
                },
                "raan": {
                  "type": "decimal",
                  "value": "23.439281"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "1.0"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "365.25638"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "-11.26064"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "114.20783"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Mars_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Mars_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.0934"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "5.65"
                },
                "raan": {
                  "type": "decimal",
                  "value": "317.68143"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "1.523679"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "686.971"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "49.558"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "286.502"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Jupiter_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Jupiter_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.0489"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "6.09"
                },
                "raan": {
                  "type": "decimal",
                  "value": "268.057"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "5.2044"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "4332.59"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "100.464"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "273.867"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Saturn_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Saturn_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.0565"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "5.51"
                },
                "raan": {
                  "type": "decimal",
                  "value": "40.589"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "9.5826"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "10759.22"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "113.665"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "339.392"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Uranus_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Uranus_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.046381"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "6.48"
                },
                "raan": {
                  "type": "decimal",
                  "value": "257.311"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "19.2184"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "30688.5"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "74.006"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "96.998856"
                }
              },
              {
                "@id": "http://www.semanticweb.org/daoneil/ontologies/2016/7/untitled-ontology-34#Neptune_Orbit",
                "type": ["CelestialEntity", "HelioCentricOrbit"],
                "name": {
                  "type": "Name",
                  "value": "Neptune_Orbit"
                },
                "eccentricity": {
                  "type": "decimal",
                  "value": "0.009456"
                },
                "inclination": {
                  "type": "decimal",
                  "value": "6.43"
                },
                "raan": {
                  "type": "decimal",
                  "value": "131.784"
                },
                "semiMajorAxis": {
                  "type": "decimal",
                  "value": "30.110387"
                },
                "sidereal": {
                  "type": "decimal",
                  "value": "60190.03"
                },
                "argPerigee": {
                  "type": "decimal",
                  "value": "131.721"
                },
                "meanAnomoly": {
                  "type": "decimal",
                  "value": "45.0"
                }
              }
            ]
          }
          
          
        </script>

        <div class="panel">
          <h1>Planet</h1>
          <div class="subtitle">Gas Giant</div>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce eleifend tortor dolor, id dapibus ex maximus ac. Duis rhoncus hendrerit libero vitae tincidunt.</p>
      
          <!-- <div class="special-options">
              <a href="#">Compare size &#9658;</a>
              <a href="#">Explore Surface &#9658;</a>
          </div> -->
      </div>
		<script>
    var raycaster, mouse, planets = [];
    var camera;
		var controls;
		var scene;
		var cube;
		var sphere;
    var sun;
		var line;
    var world;
    var stats;
    var targetPlanet = null; // The planet that camera will follow
    var offsetDistance = 5; // Distance from the planet
    var threshold = 2;
    var objNames = ["Mercury_Orbit", "Venus_Orbit", "Earth_Orbit", "Mars_Orbit", "Jupiter_Orbit", "Saturn_Orbit", "Uranus_Orbit", "Neptune_Orbit"];
    var objLen = objNames.length;
    var objSizes = [0.0000595, 0.0001479, 0.0001547, 0.0000833, 0.0017085, 0.0014195, 0.0006188, 0.0006001];
    const textureLoader = new THREE.TextureLoader();
    const starsTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/starmap_4096.jpg');
    const sunTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/8k_sun.jpg');
    const mercuryTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_mercury.jpg');
    const venusTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_venus.jpg');
    const earthTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_earth.jpg');
    const marsTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_mars.jpg');
    const jupiterTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_jupiter.jpg');
    const saturnTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_saturn.jpg');
    const uranusTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_uranus.jpg');
    const neptuneTexture = textureLoader.load(window.location.origin+'/'+'orreria'+'/planets/2k_neptune.jpg');

    var textures = [mercuryTexture, venusTexture, earthTexture, marsTexture, jupiterTexture, saturnTexture, uranusTexture, neptuneTexture]
		var curObj = new THREE.Object3D();
		var celestialBody;
		var heavenlyBodies = [];
    var Astroids = [];
		
		function init() {
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
			  controls = new THREE.TrackballControls(camera);
				controls.rotateSpeed = 2.0;
				controls.zoomSpeed = 7.0;
				controls.panSpeed = 1;
				controls.noZoom = false;
				controls.noPan = false;
				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;
        controls.minDistance = 0.12;
        controls.maxDistance = 250;
				controls.keys = [65, 83, 68];

        stats = new Stats();
				
			  scene = new THREE.Scene();
								
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        // document.body.appendChild(stats.domElement);
        document.body.appendChild(renderer.domElement);
        window.addEventListener('resize', onResize, true);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

		    var j = 0;

        var worldGeometry = new THREE.SphereGeometry(500,60,60);
        var worldMaterial = new THREE.MeshBasicMaterial(
          { color: 0xffffff ,
          map: starsTexture ,
          side: THREE.BackSide
          });
        world = new THREE.Mesh(worldGeometry, worldMaterial);
        scene.add(world);

      	//  Here comes the Sun!
        // Create the Sun (Core)
        var geometry = new THREE.SphereGeometry(0.017, 60, 60);
        var material = new THREE.MeshBasicMaterial({map: sunTexture});
        sun = new THREE.Mesh(geometry, material);
        scene.add(sun);

        // // Create the glow effect around the sun
        var glowGeometry = new THREE.SphereGeometry(0.017, 60, 60); // Slightly larger sphere for the glow border
        var glowMaterial = new THREE.MeshBasicMaterial({
            color: 0xf5bf6e, // Orange color for vintage effect
            transparent: true,
            opacity: 1, // Adjust for desired strength of the glow
            blending: THREE.AdditiveBlending // Blend mode for a soft glow effect
        });
        var glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
        sun.add(glowMesh); // Add the glow mesh around the sun

        // Optional: Create a glowing edge effect with texture
        var glowTextureLoader = new THREE.TextureLoader();
        var glowTexture = glowTextureLoader.load(window.location.origin+'/'+'orreria'+'/Shaders/glow2.png'); // Load a texture

        var glowSpriteMaterial = new THREE.SpriteMaterial({
            map: glowTexture,
            color: 0xffcd38, // Orange color for the texture
            transparent: true,
            opacity: 1, // Adjust opacity for strength
            blending: THREE.AdditiveBlending
        });

        // Create a sprite for the glowing edge effect
        var glowSprite = new THREE.Sprite(glowSpriteMaterial);
        glowSprite.scale.set(0.1, 0.1, 1); // Adjust size of the glow sprite
        glowMesh.add(glowSprite); // Attach the glow sprite to the glow mesh


        for (i = 0; i < objLen; i++) { // Add the inner planets.
      
        geometry = new THREE.SphereGeometry(objSizes[j] * 100, 60, 60);
        material = new THREE.MeshBasicMaterial({ map: textures[j] });
        planet = new THREE.Mesh(geometry, material);
        
        planet.name = objNames[i];
          planet.position.x = (i + 1) * 5;
          planets.push(planet);
          scene.add(planet);
        
          j = j + 1;
        }
        document.addEventListener('mousedown', onDocumentMouseDown, false); 
        camera.position.x = 0;
        camera.position.y = -100;
        camera.position.z = 30;		
		}

 	 	function render() {
      requestAnimationFrame(render);
      renderer.render(scene, camera);
      }  

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      stats.update();
      updatePosition();
      followPlanet();
      world.rotation.y += 0.0001;
      world.rotation.x += 0.00025;
      // glowSprite.scale.set(0.3, 0.3, 1.2); // Adjust size of the glow sprite
      sun.rotation.y += 0.001;
      sun.rotation.x += 0.0001;

      // for (i = 0; i < objLen; i++) {
      //   curObj = scene.getObjectByName(objNames[i]);
      //   // curObj.rotation.y += 0.01
      //   curObj.rotation.x += 0.01
      //   }

      renderer.render(scene, camera);
      }
     
    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onDocumentMouseDown(event) {
        event.preventDefault();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);

        var intersects = raycaster.intersectObjects(planets);

        if (intersects.length > 0) {
          var selectedPlanet = intersects[0].object;
          targetPlanet = intersects[0].object; // Store the selected planet
          console.log("Selected Planet:", targetPlanet.name);
          zoomToPlanet(selectedPlanet);
          $('.panel h1').text(selectedPlanet.name.split('_')[0]);
          $.get('https://planets-17f2.onrender.com/planets/getPlanet?name=' + selectedPlanet.name.split('_')[0], function(data) {
              data  = JSON.parse(data);
              $('.panel .subtitle').text(data.tagline);
              $('.panel p').text(data.description);
          })

          // Show the card
          $('.panel').show();
        }else {
        // If no direct hits, check if we are within the threshold distance from any planet
        for (var i = 0; i < planets.length; i++) {
            var planet = planets[i];
            var planetPosition = new THREE.Vector3();
            planet.getWorldPosition(planetPosition); // Get planet's position

            // Calculate the distance from the camera's ray to the planet's center
            var distance = raycaster.ray.distanceToPoint(planetPosition);

            if (distance < threshold) { 
                // If the distance is within the threshold, consider it a hit
                zoomToPlanet(planet);
                $('.panel h1').text(planet.name.split('_')[0]);
                $.get('https://planets-17f2.onrender.com/planets/getPlanet?name=' + planet.name.split('_')[0], function(data) {
                  data  = JSON.parse(data);
                  $('.panel .subtitle').text(data.tagline);
                  $('.panel p').text(data.description);
                  $('.panel').show();
              })
                break; // Exit loop once we found a hit within threshold
            }
        }
      }
      }

      function zoomToPlanet(planet) {
        var targetPosition = planet.position.clone();
        var zoomDistance = 2;  // Adjust as needed to control how much the camera zooms in

        // Animate camera to zoom into planet
        var tween = new TWEEN.Tween(camera.position).to({
          x: targetPosition.x * zoomDistance,
          y: targetPosition.y * zoomDistance,
          z: targetPosition.z * zoomDistance
        }, 1000).easing(TWEEN.Easing.Cubic.Out).start();

        // Adjust controls to focus on planet
        controls.target.copy(targetPosition);
      }

      function followPlanet() {
    if (targetPlanet) {
        const planetPosition = new THREE.Vector3();
        targetPlanet.getWorldPosition(planetPosition); // Get planet's world position

        // Offset the camera slightly behind or above the planet
        const cameraTargetPosition = planetPosition.clone().add(new THREE.Vector3(offsetDistance, offsetDistance, offsetDistance));

        // Smoothly move the camera to the target position (lerp for smooth transition)
        camera.position.lerp(cameraTargetPosition, 0.1); // You can adjust the 0.1 for smoothness

        // Make the camera look at the planet
        camera.lookAt(planetPosition);
    }
}

   function get_datablock() {
    // Reference https://stackoverflow.com/questions/38602543/is-there-a-way-to-access-json-ld-via-javascript-if-it-doesnt-have-an-id
	  // var jsonld = document.querySelectorAll('script[type="application/ld+json"]').innerText;
		var jsonld = document.querySelector('#OrbitOntology').innerText;
    var result = JSON.parse(jsonld);
    for(i = 0; i < result.graph.length; i++) {
      field = result.graph[i];
      if (i >= 0 && i <= objLen) { // alert(field.name.value); 

        //smA,oI,aP,oE,aN,mAe,Sidereal
        celestialBody = new Trajectory(field.name.value,
                            field.semiMajorAxis.value,
              field.inclination.value,
              field.argPerigee.value,
              field.eccentricity.value,
              field.raan.value,
              field.meanAnomoly.value,
              field.sidereal.value);
  
        heavenlyBodies.push(celestialBody);

      }		 

		}
}

function loadAstroids() {
  return new Promise((resolve, reject) => {
    $.get(window.location.origin+'/'+'orreria'+"/data.csv", function(CSVdata) {
      data = $.csv.toObjects(CSVdata);
      data.forEach(element => {
        celestialBody = new Trajectory(
          element.full_name,
          element.a,
          element.i,
          element.w,
          element.e,
          element.om,
          element.ma,
          element.per
        );

        geometry = new THREE.SphereGeometry( 0.1, 60, 60);
        material = new THREE.MeshBasicMaterial({ map: neptuneTexture });
        sphere = new THREE.Mesh(geometry, material);
        
        sphere.name = element.full_name;
        scene.add(sphere);

        Astroids.push(celestialBody);
        heavenlyBodies.push(celestialBody);
      });
      console.log(data);
      resolve(); // Resolve when the data is loaded and processed
    }).fail((err) => reject(err)); // Handle errors
  });
}

async function initApp() {
  init();
  get_datablock();
  await loadAstroids();  // Wait for loadAstroids to complete
  traceOrbits();
  animate();
  onResize();
  render();
}

// Call the main initialization function
initApp();
		  
		</script>
	</body>
</html>